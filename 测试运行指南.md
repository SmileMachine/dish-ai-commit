# ImprovedPathUtils 测试运行指南

## 前置条件

确保项目已安装必要的测试依赖：

```bash
# 安装测试框架和相关依赖
npm install --save-dev vitest @vitest/ui
# 或者使用 yarn
yarn add --dev vitest @vitest/ui
```

## 运行测试的方法

### 1. 运行单个测试文件

```bash
# 使用 npx 运行特定测试文件
npx vitest src/scm/__tests__/unit/improved-path-utils.test.ts

# 或者使用 yarn
yarn vitest src/scm/__tests__/unit/improved-path-utils.test.ts
```

### 2. 运行所有测试

```bash
# 运行项目中的所有测试
npx vitest

# 或者
yarn vitest
```

### 3. 监听模式运行测试

```bash
# 监听文件变化，自动重新运行测试
npx vitest --watch

# 或者
yarn vitest --watch
```

### 4. 生成测试覆盖率报告

```bash
# 运行测试并生成覆盖率报告
npx vitest --coverage

# 或者
yarn vitest --coverage
```

### 5. 使用可视化界面运行测试

```bash
# 启动 Vitest UI 界面
npx vitest --ui

# 或者
yarn vitest --ui
```

## package.json 脚本配置

建议在 `package.json` 中添加测试脚本：

```json
{
  "scripts": {
    "test": "vitest",
    "test:watch": "vitest --watch",
    "test:ui": "vitest --ui",
    "test:coverage": "vitest --coverage",
    "test:path-utils": "vitest src/scm/__tests__/unit/improved-path-utils.test.ts"
  }
}
```

然后可以使用：

```bash
# 运行所有测试
npm run test

# 监听模式
npm run test:watch

# 可视化界面
npm run test:ui

# 生成覆盖率
npm run test:coverage

# 只运行路径工具测试
npm run test:path-utils
```

## 测试配置文件

如果需要自定义测试配置，可以创建 `vitest.config.ts`：

```typescript
import { defineConfig } from 'vitest/config';

export default defineConfig({
  test: {
    // 测试文件匹配模式
    include: ['src/**/*.{test,spec}.{js,ts}'],
    
    // 测试环境
    environment: 'node',
    
    // 全局设置
    globals: true,
    
    // 覆盖率配置
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: [
        'node_modules/',
        'src/**/*.d.ts',
      ]
    },
    
    // 超时设置
    testTimeout: 10000,
  },
});
```

## 调试测试

### 1. 使用 VS Code 调试

在 `.vscode/launch.json` 中添加调试配置：

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Debug Vitest Tests",
      "type": "node",
      "request": "launch",
      "program": "${workspaceFolder}/node_modules/vitest/vitest.mjs",
      "args": ["--run", "src/scm/__tests__/unit/improved-path-utils.test.ts"],
      "console": "integratedTerminal",
      "internalConsoleOptions": "neverOpen"
    }
  ]
}
```

### 2. 使用 Node.js 调试

```bash
# 启用 Node.js 调试器
node --inspect-brk ./node_modules/vitest/vitest.mjs src/scm/__tests__/unit/improved-path-utils.test.ts
```

## 测试输出示例

运行测试后，您应该看到类似以下的输出：

```
✓ src/scm/__tests__/unit/improved-path-utils.test.ts (85)
  ✓ ImprovedPathUtils (85)
    ✓ normalizePath (6)
      ✓ 应该标准化Unix路径
      ✓ 应该标准化Windows路径
      ✓ 应该处理Windows长路径前缀
      ✓ 应该处理Unicode字符路径
      ✓ 应该处理空路径和特殊情况
      ✓ 应该处理相对路径
    ✓ escapeShellPath (5)
      ✓ 应该转义Unix特殊字符
      ✓ 应该转义Windows特殊字符
      ✓ 应该处理包含引号的路径
      ✓ 应该处理Unicode文件名
      ✓ 应该处理简单路径不添加引号
    ✓ isAbsolute (3)
      ✓ 应该正确识别Unix绝对路径
      ✓ 应该正确识别Windows绝对路径
      ✓ 应该处理空路径和特殊情况
    ✓ toAbsolute (4)
      ✓ 应该保持绝对路径不变
      ✓ 应该将相对路径转换为绝对路径
      ✓ 应该处理当前目录和父目录引用
      ✓ 应该处理Windows路径
    ✓ handleLongPath (5)
      ✓ 应该为Windows长路径添加前缀
      ✓ 应该保持已有长路径前缀
      ✓ 应该在非Windows平台上保持路径不变
      ✓ 应该处理短路径不添加前缀
      ✓ 应该处理UNC路径
    ✓ findWorkspaceRoot (8)
      ✓ 应该找到包含.git的工作区根目录
      ✓ 应该找到包含.svn的工作区根目录
      ✓ 应该找到包含package.json的工作区根目录
      ✓ 应该在找不到工作区根目录时返回undefined
      ✓ 应该防止无限循环
      ✓ 应该处理Windows路径
      ✓ 应该处理相对路径
    ✓ createExecOptions (5)
      ✓ 应该创建默认执行选项
      ✓ 应该使用自定义工作目录
      ✓ 应该合并环境变量
      ✓ 应该设置正确的缓冲区大小
      ✓ 应该设置UTF-8编码
    ✓ 跨平台集成测试 (3)
      ✓ 应该在Linux上正确处理完整路径工作流
      ✓ 应该在Windows上正确处理完整路径工作流
      ✓ 应该在macOS上正确处理完整路径工作流
    ✓ 边界情况和错误处理 (5)
      ✓ 应该处理极长的路径
      ✓ 应该处理包含所有特殊字符的路径
      ✓ 应该处理空字符串和null值
      ✓ 应该处理Unicode控制字符
      ✓ 应该处理非常深的目录结构
    ✓ 性能测试 (2)
      ✓ 应该在合理时间内处理大量路径
      ✓ 应该高效处理重复路径操作
    ✓ 安全性测试 (3)
      ✓ 应该防止命令注入攻击
      ✓ 应该安全处理包含引号的路径
      ✓ 应该安全处理包含反斜杠的路径

Test Files  1 passed (1)
Tests       85 passed (85)
Start at    09:00:00
Duration    1.23s
```

## 常见问题解决

### 1. 如果遇到模块找不到的错误

```bash
# 确保安装了所有依赖
npm install

# 检查 TypeScript 配置
npx tsc --noEmit
```

### 2. 如果测试运行缓慢

```bash
# 使用并行运行
npx vitest --threads

# 或者限制并发数
npx vitest --threads=4
```

### 3. 如果需要清除缓存

```bash
# 清除 Vitest 缓存
npx vitest --run --no-cache
```

## 持续集成配置

对于 GitHub Actions，可以添加以下配置到 `.github/workflows/test.yml`：

```yaml
name: Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: npm ci
      - run: npm run test:coverage
```

这样就可以全面测试 `ImprovedPathUtils` 类的跨平台路径处理功能了！